<!-- AnCapTruyenLamVideo - Manga Crawler Component Template -->
<p-toast />

<div class="crawler-container">
  <!-- YouTube Settings -->
  <p-card header="YouTube Settings" styleClass="youtube-card">
    <div class="youtube-settings">
      @if (youtubeStatus()) {
        <div class="youtube-status">
          <div class="status-info">
            <i class="pi pi-youtube" style="font-size: 1.5rem; color: #ff0000;"></i>
            <div class="status-text">
              @if (youtubeStatus()!.authenticated) {
                <span class="connected">YouTube Connected</span>
                <small>Videos will be auto-uploaded ({{ youtubeStatus()!.privacy }})</small>
              } @else {
                <span class="disconnected">YouTube Not Connected</span>
                <small>Connect to enable auto-upload</small>
              }
            </div>
          </div>
          <div class="status-actions">
            @if (youtubeStatus()!.authenticated) {
              <p-button
                label="Disconnect"
                icon="pi pi-times"
                severity="secondary"
                [outlined]="true"
                [loading]="youtubeLoading()"
                (click)="disconnectYouTube()"
              />
            } @else {
              <p-button
                label="Connect YouTube"
                icon="pi pi-youtube"
                severity="danger"
                [loading]="youtubeLoading()"
                (click)="connectYouTube()"
              />
            }
          </div>
        </div>
      } @else {
        <div class="youtube-loading">
          <i class="pi pi-spin pi-spinner"></i>
          <span>Loading YouTube status...</span>
        </div>
      }
    </div>
  </p-card>

  <!-- Input Section -->
  <p-card header="Manga Crawler" subheader="Crawl manga from truyenqqno.com and generate Vietnamese video scripts">
    <div class="input-section">
      <div class="p-inputgroup">
        <span class="p-inputgroup-addon">
          <i class="pi pi-link"></i>
        </span>
        <input
          type="text"
          pInputText
          [(ngModel)]="mangaUrl"
          placeholder="Enter manga URL from truyenqqno.com"
          [disabled]="isLoading()"
          (keyup.enter)="startCrawl()"
        />
        <p-button
          label="Start Crawl"
          icon="pi pi-play"
          (click)="startCrawl()"
          [disabled]="isLoading()"
          [loading]="isLoading()"
        />
      </div>
      <small class="hint">
        Example: https://truyenqqno.com/truyen-tranh/tro-thanh-hung-than-trong-tro-choi-thu-thanh-12692
      </small>
    </div>
  </p-card>

  <!-- Progress Section -->
  @if (currentTask()) {
    <p-card class="progress-card">
      <ng-template pTemplate="header">
        <div class="task-header">
          <div class="task-title">
            <h3>{{ currentTask()!.manga_title || 'Loading manga info...' }}</h3>
            <p-tag
              [value]="statusConfig().label"
              [severity]="statusConfig().severity"
            />
          </div>
          @if (isLoading()) {
            <p-button
              label="Cancel"
              icon="pi pi-times"
              severity="danger"
              [outlined]="true"
              (click)="cancelCrawl()"
            />
          }
        </div>
      </ng-template>

      <!-- Progress Bar -->
      <div class="progress-section">
        <p-progressBar
          [value]="overallProgress()"
          [showValue]="true"
        />

        <div class="stats-grid">
          <div class="stat-item">
            <span class="stat-label">Chapters</span>
            <span class="stat-value">
              {{ currentTask()!.chapters_crawled }} / {{ currentTask()!.total_chapters }}
            </span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Images</span>
            <span class="stat-value">
              {{ currentTask()!.images_downloaded }}
            </span>
          </div>
          <div class="stat-item">
            <span class="stat-label">AI Batches</span>
            <span class="stat-value">
              {{ currentTask()!.batches_processed }} / {{ currentTask()!.total_batches }}
            </span>
          </div>
          @if (currentTask()!.status === 'generating_video' || currentTask()!.video_file) {
            <div class="stat-item">
              <span class="stat-label">Video</span>
              <span class="stat-value">
                @if (currentTask()!.video_file) {
                  Ready
                } @else {
                  {{ currentTask()!.video_progress || 0 }}%
                }
              </span>
            </div>
          }
        </div>
      </div>

      <!-- Progress Log -->
      <div class="log-section">
        <h4>Progress Log</h4>
        <p-scrollPanel [style]="{ width: '100%', height: '200px' }">
          <div class="log-container">
            @for (event of progressEvents(); track $index) {
              <div class="log-entry" [class]="'log-' + event.event_type">
                <i class="pi" [ngClass]="{
                  'pi-check-circle': event.event_type === 'task_completed' || event.event_type === 'batch_completed' || event.event_type === 'video_completed',
                  'pi-times-circle': event.event_type === 'task_failed',
                  'pi-spin pi-spinner': event.event_type.includes('processing') || event.event_type.includes('crawl') || event.event_type.includes('video_generating') || event.event_type.includes('video_progress'),
                  'pi-download': event.event_type === 'image_downloaded',
                  'pi-video': event.event_type.includes('video'),
                  'pi-list': event.event_type === 'chapters_found',
                  'pi-info-circle': !['task_completed', 'task_failed', 'batch_completed', 'video_completed'].includes(event.event_type) && !event.event_type.includes('video')
                }"></i>
                <span class="log-message">{{ event.message }}</span>
              </div>
            }
            @if (progressEvents().length === 0) {
              <div class="log-entry log-info">
                <i class="pi pi-info-circle"></i>
                <span class="log-message">Waiting for progress updates...</span>
              </div>
            }
          </div>
        </p-scrollPanel>
      </div>

      <!-- Video Output -->
      @if (currentTask()!.video_file) {
        <div class="output-section video-section">
          <h4>Generated Video</h4>
          <div class="file-list">
            <p-button
              [label]="getFileName(currentTask()!.video_file!)"
              icon="pi pi-video"
              severity="success"
              (click)="downloadVideo()"
            />
            @if (currentTask()!.youtube_video_id) {
              <p-button
                label="View on YouTube"
                icon="pi pi-youtube"
                severity="danger"
                (click)="openYouTube(currentTask()!.youtube_video_id!)"
              />
            }
          </div>
        </div>
      }

      <!-- Script Files -->
      @if (currentTask()!.output_files && currentTask()!.output_files.length > 0) {
        <div class="output-section">
          <h4>Generated Scripts</h4>
          <div class="file-list">
            @for (file of currentTask()!.output_files; track file) {
              @if (!file.includes('.mp4')) {
                <p-button
                  [label]="getFileName(file)"
                  icon="pi pi-download"
                  [outlined]="true"
                  (click)="downloadScript(getFileName(file))"
                />
              }
            }
          </div>
        </div>
      }

      <!-- Error Message -->
      @if (currentTask()!.error_message) {
        <div class="error-section">
          <p-tag severity="danger" value="Error" />
          <span class="error-message">{{ currentTask()!.error_message }}</span>
        </div>
      }
    </p-card>
  }
</div>
